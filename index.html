<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Sistema de Riego Inteligente – Prototipo 1 sector</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- MQTT.js (para WebSocket con EMQX) -->
  <script src="https://unpkg.com/mqtt@4.3.7/dist/mqtt.min.js"></script>
  <!-- Chart.js para gráficas -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --bg-main:#050814;
      --bg-panel:#0c1020;
      --bg-card:#10162a;
      --accent:#3cf2a5;
      --accent-soft:rgba(60,242,165,0.15);
      --danger:#ff4f6b;
      --danger-soft:rgba(255,79,107,0.15);
      --text-main:#f8fbff;
      --text-soft:#a5b2d9;
      --border-soft:#232a45;
      --chip-bg:#111626;
      --chip-soft:#1b2237;
    }
    *{box-sizing:border-box;}
    html,body{
      margin:0;
      padding:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#151b33 0,#050814 60%);
      color:var(--text-main);
    }
    body{padding:18px 22px 28px;}
    .page{
      max-width:1400px;
      margin:0 auto;
    }
    .top-bar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
    }
    .title-main{
      font-size:20px;
      font-weight:600;
      letter-spacing:.03em;
    }
    .subtitle{
      font-size:11px;
      color:var(--text-soft);
      margin-top:4px;
    }
    .status-group{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 9px;
      border-radius:999px;
      background:var(--chip-bg);
      border:1px solid var(--border-soft);
      font-size:11px;
      color:var(--text-soft);
    }
    .chip-dot{
      width:8px;
      height:8px;
      border-radius:50%;
      background:#535b7a;
    }
    .chip-dot.ok{background:var(--accent);}
    .chip-dot.warn{background:#f7b500;}
    .chip-dot.err{background:var(--danger);}

    .chip.badge-danger{
      border-color:var(--danger);
      background:var(--danger-soft);
      color:#ffd7df;
    }
    .chip.badge-ok{
      border-color:var(--accent);
      background:var(--accent-soft);
      color:#c5ffe4;
    }

    .grid-main{
      display:grid;
      gap:12px;
      grid-template-columns:minmax(0,1.1fr) minmax(0,1.3fr) minmax(0,1.1fr);
      margin-bottom:14px;
    }
    .panel{
      background:var(--bg-panel);
      border-radius:16px;
      padding:12px 14px;
      border:1px solid rgba(255,255,255,0.03);
      box-shadow:0 16px 40px rgba(0,0,0,0.45);
    }
    .panel-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    .panel-title{
      font-size:12px;
      font-weight:600;
      letter-spacing:.06em;
      text-transform:uppercase;
      color:#d2ddff;
    }
    .panel-tag{
      font-size:10px;
      color:var(--text-soft);
      padding:2px 7px;
      border-radius:999px;
      border:1px solid var(--border-soft);
      background:#070a16;
    }

    .metric-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:8px;
      margin-top:4px;
    }
    .metric{
      background:var(--bg-card);
      border-radius:14px;
      padding:8px 9px 8px;
      border:1px solid rgba(52,65,109,0.85);
      display:flex;
      flex-direction:column;
      gap:3px;
    }
    .metric-label{
      font-size:11px;
      color:var(--text-soft);
    }
    .metric-value{
      font-size:16px;
      font-weight:600;
    }
    .metric-caption{
      font-size:10px;
      color:var(--text-soft);
    }
    .metric-status{
      font-size:10px;
      margin-top:1px;
      color:var(--text-soft);
    }
    .metric-status.ok{color:#3cf2a5;}
    .metric-status.warn{color:#f7b500;}
    .metric-status.bad{color:#ff4f6b;}
    .metric-status.info{color:#7fc0ff;}

    .status-card{
      margin-top:8px;
      background:var(--bg-card);
      border-radius:14px;
      padding:8px 9px;
      border:1px solid rgba(52,65,109,0.85);
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .status-title{
      font-size:11px;
      color:var(--text-soft);
    }
    .status-main{
      font-size:14px;
      font-weight:600;
    }
    .status-caption{
      font-size:10px;
      color:var(--text-soft);
    }

    .btn{
      border-radius:999px;
      border:1px solid var(--border-soft);
      background:var(--chip-bg);
      color:var(--text-soft);
      padding:6px 11px;
      font-size:11px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      cursor:pointer;
      transition:background .15s,border-color .15s,transform .04s;
      user-select:none;
    }
    .btn:hover{background:var(--chip-soft);}
    .btn:active{transform:scale(.97);}
    .btn-primary{
      background:var(--accent-soft);
      border-color:var(--accent);
      color:#c6ffe7;
    }
    .btn-danger{
      background:var(--danger-soft);
      border-color:var(--danger);
      color:#ffe3ea;
    }
    .btn-sm{
      padding:4px 9px;
      font-size:10px;
    }
    .btn-toggle{
      min-width:68px;
    }
    .btn-toggle.active{
      background:var(--accent-soft);
      border-color:var(--accent);
      color:#c6ffe7;
    }

    .row-btns{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:8px;
    }

    .setpoints-block{margin-top:10px;}
    .card-sub{
      font-size:11px;
      color:var(--text-soft);
    }
    .setpoints-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(230px,1fr));
      gap:10px;
      margin-top:8px;
    }
    .sp-item{
      background:var(--bg-card);
      border-radius:14px;
      padding:8px 10px 9px;
      border:1px solid rgba(52,65,109,0.9);
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .sp-label{
      font-size:11px;
      color:var(--text-soft);
      font-weight:500;
    }
    .sp-row{
      display:flex;
      align-items:center;
      gap:6px;
    }
    .sp-row input{
      width:70px;
      background:#050814;
      border-radius:8px;
      border:1px solid var(--border-soft);
      padding:4px 6px;
      color:var(--text-main);
      font-size:11px;
      text-align:center;
    }
    .sp-row input:focus{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(60,242,165,0.5);
    }
    .sp-sep{
      font-size:10px;
      color:var(--text-soft);
    }
    .sp-btn{
      font-size:10px;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid var(--border-soft);
      background:var(--chip-bg);
      color:var(--text-soft);
      cursor:pointer;
      white-space:nowrap;
    }
    .sp-btn:hover{background:var(--chip-soft);}

    .panel-sector .sector-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:4px;
    }
    .sector-title{
      font-size:12px;
      font-weight:500;
    }
    .sector-caption{
      font-size:10px;
      color:var(--text-soft);
    }
    .sector-card{
      margin-top:8px;
      background:var(--bg-card);
      border-radius:14px;
      padding:8px 10px;
      border:1px solid rgba(52,65,109,0.9);
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .sector-switch{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .switch-pill{
      width:44px;
      height:22px;
      border-radius:999px;
      background:#060915;
      border:1px solid var(--border-soft);
      position:relative;
      cursor:pointer;
      transition:background .2s,border-color .2s;
    }
    .switch-knob{
      position:absolute;
      top:2px;
      left:3px;
      width:16px;
      height:16px;
      border-radius:50%;
      background:#b2bedf;
      transition:left .2s,background .2s;
    }
    .switch-pill.on{
      background:var(--accent-soft);
      border-color:var(--accent);
    }
    .switch-pill.on .switch-knob{
      left:23px;
      background:#e8fff7;
    }

    .events-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:10px;
      margin-bottom:4px;
    }
    .events-title{
      font-size:11px;
      color:var(--text-soft);
    }
    .log-box{
      background:var(--bg-card);
      border-radius:12px;
      border:1px solid rgba(52,65,109,0.9);
      max-height:172px;
      padding:4px 6px;
      font-size:10px;
      overflow-y:auto;
    }
    .log-line{
      display:flex;
      gap:6px;
      white-space:nowrap;
    }
    .log-time{
      color:#7a87b4;
      flex-shrink:0;
    }
    .log-text{
      color:var(--text-soft);
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .panel-bottom{
      margin-top:10px;
      background:var(--bg-panel);
      border-radius:16px;
      padding:12px 14px 16px;
      border:1px solid rgba(255,255,255,0.03);
      box-shadow:0 16px 40px rgba(0,0,0,0.45);
    }
    .bottom-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    .bottom-title{
      font-size:12px;
      font-weight:600;
      letter-spacing:.06em;
      color:#d2ddff;
      text-transform:uppercase;
    }
    .bottom-sub{
      font-size:11px;
      color:var(--text-soft);
    }
    .range-switch{
      display:flex;
      gap:6px;
    }
    .range-btn{
      padding:3px 8px;
      font-size:10px;
      border-radius:999px;
      border:1px solid var(--border-soft);
      background:var(--chip-bg);
      color:var(--text-soft);
      cursor:pointer;
    }
    .range-btn.active{
      background:var(--accent-soft);
      border-color:var(--accent);
      color:#c6ffe7;
    }

    .charts-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px;
    }
    /* Altura fija para que el canvas no crezca infinito */
    .chart-card{
      background:var(--bg-card);
      border-radius:14px;
      padding:8px 10px 10px;
      border:1px solid rgba(52,65,109,0.9);
      height:230px;
      display:flex;
      flex-direction:column;
    }
    .chart-card canvas{
      flex:1;
      width:100% !important;
      height:100% !important;
    }
    .chart-title{
      font-size:11px;
      color:var(--text-soft);
      margin-bottom:4px;
    }

    @media (max-width:1024px){
      .grid-main{
        grid-template-columns:1fr;
      }
    }
  </style>
</head>
<body>
<div class="page">
  <header class="top-bar">
    <div>
      <div class="title-main">SISTEMA DE RIEGO INTELIGENTE – PALTA FUERTE</div>
      <div class="subtitle">Parcela piloto – Prototipo 1 sector (ESP32 + IoT)</div>
    </div>
    <div class="status-group">
      <div class="chip" id="chipControl">
        <span class="chip-dot err" id="dotControl"></span>
        <span id="txtControl">Control detenido</span>
      </div>
      <div class="chip" id="chipMode">
        <span>Modo actual:</span>
        <strong id="txtMode">Manual</strong>
      </div>
      <div class="chip" id="chipMqtt">
        <span class="chip-dot" id="dotMqtt"></span>
        <span>MQTT:</span>
        <strong id="txtMqtt">Desconectado</strong>
      </div>
      <div class="chip" id="chipEsp">
        <span class="chip-dot" id="dotEsp"></span>
        <span id="txtEsp">ESP32: Sin actualización reciente</span>
      </div>
    </div>
  </header>

  <main class="grid-main">
    <!-- Panel izquierda: monitoreo -->
    <section class="panel">
      <div class="panel-header">
        <div class="panel-title">Monitoreo en tiempo real</div>
        <div class="panel-tag">Datos desde ESP32</div>
      </div>
      <div class="metric-grid">
        <div class="metric">
          <div class="metric-label">Temperatura aire</div>
          <div class="metric-value" id="valTair">-- °C</div>
          <div class="metric-caption">Rango sugerido: 18–30 °C</div>
        </div>
        <div class="metric">
          <div class="metric-label">Humedad relativa</div>
          <div class="metric-value" id="valRh">-- %</div>
          <div class="metric-status" id="bandRh">Sin datos</div>
          <div class="metric-caption">Objetivo: 40–70 %</div>
        </div>
        <div class="metric">
          <div class="metric-label">Déficit de presión de vapor (VPD)</div>
          <div class="metric-value" id="valVpd">-- kPa</div>
          <div class="metric-status" id="bandVpd">Sin datos</div>
          <div class="metric-caption">Banda objetivo: 0.6–1.2 kPa</div>
        </div>
        <div class="metric">
          <div class="metric-label">Radiación en copa</div>
          <div class="metric-value" id="valRad">-- lux</div>
          <div class="metric-status" id="bandRad">Sin datos</div>
          <div class="metric-caption">Límite para riego: &lt; 60 000 lux</div>
        </div>
        <div class="metric">
          <div class="metric-label">Humedad de suelo S1 (sector único)</div>
          <div class="metric-value" id="valSoil1">-- %</div>
          <div class="metric-status" id="bandSoil1">Sin datos</div>
          <div class="metric-caption">Banda objetivo: 30–60 %</div>
        </div>
        <div class="metric">
          <div class="metric-label">Estado general</div>
          <div class="metric-value" id="valEstado">Detenido</div>
          <div class="metric-caption" id="valEstadoDet">Esperando activación de control.</div>
        </div>
      </div>
    </section>

    <!-- Panel central: control principal -->
    <section class="panel">
      <div class="panel-header">
        <div class="panel-title">Control principal</div>
        <div class="panel-tag">Modo de operación + lógica VPD + suelo</div>
      </div>

      <div class="row-btns">
        <button class="btn btn-primary" id="btnControlAuto">Activar control automático</button>
        <button class="btn btn-danger" id="btnStop">Paro de emergencia</button>
      </div>

      <div style="margin-top:10px;">
        <div style="font-size:11px;color:var(--text-soft);margin-bottom:4px;">Selección de modo (global)</div>
        <div class="row-btns">
          <button class="btn btn-sm btn-toggle active" id="btnModeManual">Manual</button>
          <button class="btn btn-sm btn-toggle" id="btnModeAuto">Automático</button>
        </div>
      </div>

      <div class="status-card" style="margin-top:10px;">
        <div class="status-title">Alarmas activas (sensores, VPD y riego)</div>
        <div class="status-main" id="txtAlarmas">Sin alarmas activas.</div>
        <div class="row-btns" style="margin-top:6px;">
          <button class="btn btn-sm" id="btnAlarmTest">Generar alarma de prueba</button>
          <button class="btn btn-sm" id="btnAlarmAck">Reconocer todas</button>
        </div>
      </div>

      <!-- Banda de setpoints -->
      <div class="setpoints-block">
        <div class="card-sub">Banda de setpoints (prototipo)</div>
        <div class="setpoints-grid">
          <div class="sp-item">
            <div class="sp-label">Banda VPD (kPa)</div>
            <div class="sp-row">
              <span class="sp-sep">mín</span>
              <input id="spVpdMin" type="number" step="0.05" />
              <span class="sp-sep">máx</span>
              <input id="spVpdMax" type="number" step="0.05" />
              <button class="sp-btn" id="btnSpVpd">Enviar</button>
            </div>
          </div>
          <div class="sp-item">
            <div class="sp-label">Humedad suelo (%)</div>
            <div class="sp-row">
              <span class="sp-sep">mín</span>
              <input id="spSoilMin" type="number" step="1" />
              <span class="sp-sep">máx</span>
              <input id="spSoilMax" type="number" step="1" />
              <button class="sp-btn" id="btnSpSoil">Enviar</button>
            </div>
          </div>
          <div class="sp-item">
            <div class="sp-label">Radiación máx. (lux)</div>
            <div class="sp-row">
              <span class="sp-sep">máx</span>
              <input id="spRadMax" type="number" step="1000" />
              <button class="sp-btn" id="btnSpRad">Enviar</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Panel derecha: control de sector -->
    <section class="panel panel-sector">
      <div class="panel-header">
        <div class="panel-title">Control de sector</div>
        <div class="panel-tag">Válvula de riego único (Sector 1)</div>
      </div>

      <div class="sector-card">
        <div>
          <div class="sector-title">Válvula Sector 1</div>
          <div class="sector-caption">Hilera principal (10 m aprox.)</div>
        </div>
        <div class="sector-switch">
          <span style="font-size:11px;color:var(--text-soft);" id="txtValve1">OFF</span>
          <div class="switch-pill" id="switchValve1">
            <div class="switch-knob"></div>
          </div>
        </div>
      </div>

      <div class="events-header">
        <div class="events-title">Eventos recientes</div>
        <button class="btn btn-sm" id="btnClearLog">Limpiar log</button>
      </div>
      <div class="log-box" id="logList"></div>
      <div style="margin-top:4px;font-size:9px;color:var(--text-soft);text-align:right;">
        Mensajes MQTT y cambios de estado.
      </div>
    </section>
  </main>

  <!-- Histórico -->
  <section class="panel-bottom">
    <div class="bottom-header">
      <div>
        <div class="bottom-title">Histórico de variables</div>
        <div class="bottom-sub">Últimos días desde Supabase (bridge Node en Render)</div>
      </div>
      <div class="range-switch">
        <button class="range-btn active" id="btnRange24h">Últimas 24 h</button>
        <button class="range-btn" id="btnRange3d">Últimos 3 días</button>
      </div>
    </div>
    <div class="charts-grid">
      <div class="chart-card">
        <div class="chart-title">Temperatura y humedad relativa</div>
        <canvas id="chartTempHum"></canvas>
      </div>
      <div class="chart-card">
        <div class="chart-title">Humedad de suelo (Sector único)</div>
        <canvas id="chartSoil"></canvas>
      </div>
    </div>
  </section>
</div>

<script>
  // ================= CONFIG =====================
  const MQTT_URL = "wss://broker.emqx.io:8084/mqtt";
  const MQTT_TOPIC_STATE = "riego/estado";
  const MQTT_TOPIC_CMD   = "riego/cmd";

  // Backend para histórico (Render)
  const HISTORY_API_BASE = "https://riego-bridge.onrender.com";

  // Setpoints base
  const cfgSetpoints = {
    vpdMin:0.6,
    vpdMax:1.2,
    soilMin:30,
    soilMax:60,
    radMax:60000
  };

  // ================= ESTADO UI ==================
  let mqttClient = null;
  let mqttConnected = false;
  let lastStateTs = 0;
  const ESP32_STALE_MS = 30000;

  let currentSystemOn = false;
  let currentMode = "MANUAL";
  let valve1State = false;

  // Histórico
  let chartTempHum, chartSoil;
  let currentHistoryDays = 1;
  let historyLoading = false;

  // ============== DOM HELPERS ===================
  const $ = (id) => document.getElementById(id);

  const elChipControl = $("chipControl");
  const elDotControl  = $("dotControl");
  const elTxtControl  = $("txtControl");

  const elTxtMode  = $("txtMode");

  const elDotMqtt  = $("dotMqtt");
  const elTxtMqtt  = $("txtMqtt");

  const elDotEsp   = $("dotEsp");
  const elTxtEsp   = $("txtEsp");

  const elValTair  = $("valTair");
  const elValRh    = $("valRh");
  const elValVpd   = $("valVpd");
  const elValRad   = $("valRad");
  const elValSoil1 = $("valSoil1");
  const elValEstado= $("valEstado");
  const elValEstadoDet = $("valEstadoDet");

  const elBandRh   = $("bandRh");
  const elBandVpd  = $("bandVpd");
  const elBandRad  = $("bandRad");
  const elBandSoil1= $("bandSoil1");

  const elBtnControlAuto = $("btnControlAuto");
  const elBtnStop        = $("btnStop");
  const elBtnModeManual  = $("btnModeManual");
  const elBtnModeAuto    = $("btnModeAuto");

  const elSwitchValve1   = $("switchValve1");
  const elTxtValve1      = $("txtValve1");

  const elLogList        = $("logList");

  const spVpdMin = $("spVpdMin");
  const spVpdMax = $("spVpdMax");
  const spSoilMin= $("spSoilMin");
  const spSoilMax= $("spSoilMax");
  const spRadMax = $("spRadMax");
  const btnSpVpd = $("btnSpVpd");
  const btnSpSoil= $("btnSpSoil");
  const btnSpRad = $("btnSpRad");

  const btnRange24h = $("btnRange24h");
  const btnRange3d  = $("btnRange3d");

  // ================== UI STATUS =================
  function setControlStatus(){
    if(currentSystemOn){
      elChipControl.classList.add("badge-ok");
      elChipControl.classList.remove("badge-danger");
      elDotControl.classList.add("ok");
      elDotControl.classList.remove("err");
      elTxtControl.textContent = "Control en marcha";
      elValEstado.textContent = "En operación";
      elValEstadoDet.textContent = "Lógica de control activa.";
    }else{
      elChipControl.classList.add("badge-danger");
      elChipControl.classList.remove("badge-ok");
      elDotControl.classList.add("err");
      elDotControl.classList.remove("ok");
      elTxtControl.textContent = "Control detenido";
      elValEstado.textContent = "Detenido";
      elValEstadoDet.textContent = "Esperando activación de control.";
    }

    elTxtMode.textContent = currentMode === "AUTO" ? "Automático" : "Manual";
    if(currentMode === "AUTO"){
      elBtnModeAuto.classList.add("active");
      elBtnModeManual.classList.remove("active");
    }else{
      elBtnModeManual.classList.add("active");
      elBtnModeAuto.classList.remove("active");
    }
  }

  function setMqttStatus(ok){
    mqttConnected = ok;
    if(ok){
      elDotMqtt.classList.add("ok");
      elDotMqtt.classList.remove("err");
      elTxtMqtt.textContent = "Conectado al broker MQTT";
    }else{
      elDotMqtt.classList.remove("ok");
      elDotMqtt.classList.add("err");
      elTxtMqtt.textContent = "MQTT desconectado";
    }
  }

  function updateEsp32Status(){
    const age = Date.now() - lastStateTs;
    if(lastStateTs === 0){
      elDotEsp.classList.remove("ok","warn");
      elTxtEsp.textContent = "ESP32: Sin actualización reciente";
      return;
    }
    if(age < ESP32_STALE_MS){
      elDotEsp.classList.add("ok");
      elDotEsp.classList.remove("warn");
      elTxtEsp.textContent = "ESP32: En línea";
    }else{
      elDotEsp.classList.remove("ok");
      elDotEsp.classList.add("warn");
      elTxtEsp.textContent = "ESP32: Sin datos recientes";
    }
  }

  function setMetric(el, value, suffix = "", decimals = 1){
    if(typeof value !== "number" || isNaN(value)){
      el.textContent = `-- ${suffix}`.trim();
    }else{
      el.textContent = `${value.toFixed(decimals)} ${suffix}`.trim();
    }
  }

  function clearBandClass(el){
    el.classList.remove("ok","bad","warn","info");
  }

  function setBandStatus(el, value, min, max){
    clearBandClass(el);
    if(typeof value !== "number" || isNaN(value)){
      el.textContent = "Sin datos";
      return;
    }
    if(value < min){
      el.textContent = "Por debajo de banda";
      el.classList.add("warn");
    }else if(value > max){
      el.textContent = "Por encima de banda";
      el.classList.add("bad");
    }else{
      el.textContent = "En banda óptima";
      el.classList.add("ok");
    }
  }

  function setRadStatus(el,value,max){
    clearBandClass(el);
    if(typeof value !== "number" || isNaN(value)){
      el.textContent = "Sin datos";
      return;
    }
    if(value < max){
      el.textContent = "Riego habilitado";
      el.classList.add("ok");
    }else{
      el.textContent = "Riego bloqueado por radiación";
      el.classList.add("bad");
    }
  }

  // ================= LOG ========================
  function addLog(text){
    const now = new Date();
    const hh = String(now.getHours()).padStart(2,"0");
    const mm = String(now.getMinutes()).padStart(2,"0");
    const ss = String(now.getSeconds()).padStart(2,"0");
    const line = document.createElement("div");
    line.className = "log-line";
    const t = document.createElement("span");
    t.className = "log-time";
    t.textContent = `${hh}:${mm}:${ss}`;
    const msg = document.createElement("span");
    msg.className = "log-text";
    msg.textContent = text;
    line.appendChild(t);
    line.appendChild(msg);
    elLogList.prepend(line);
  }

  // ================= MQTT =======================
  function publishCmd(obj){
    if(!mqttClient || !mqttConnected) return;
    try{
      const payload = JSON.stringify(obj);
      mqttClient.publish(MQTT_TOPIC_CMD, payload);
      addLog(`CMD → ${payload}`);
    }catch(e){
      console.error("Error publicando CMD:", e);
    }
  }

  function connectMqtt(){
    addLog("Conectando al broker MQTT...");
    mqttClient = mqtt.connect(MQTT_URL,{
      clean:true,
      connectTimeout:4000,
      reconnectPeriod:4000
    });

    mqttClient.on("connect",()=>{
      setMqttStatus(true);
      addLog("Conectado al broker MQTT.");
      mqttClient.subscribe(MQTT_TOPIC_STATE,(err)=>{
        if(err) addLog("Error al suscribir a riego/estado.");
        else addLog("Suscrito a riego/estado.");
      });
    });

    mqttClient.on("reconnect",()=>{
      setMqttStatus(false);
      addLog("Intentando reconexión MQTT...");
    });

    mqttClient.on("close",()=>{
      setMqttStatus(false);
      addLog("MQTT desconectado.");
    });

    mqttClient.on("error",(err)=>{
      console.error("MQTT error:", err);
      addLog("Error MQTT: " + err.message);
    });

    mqttClient.on("message",(topic,payload)=>{
      if(topic !== MQTT_TOPIC_STATE) return;
      try{
        const txt = payload.toString();
        const data = JSON.parse(txt);
        handleStateMessage(data);
      }catch(e){
        console.error("Error parseando estado:", e);
        addLog("Error al parsear mensaje de estado.");
      }
    });
  }

  function handleStateMessage(s){
    lastStateTs = Date.now();
    updateEsp32Status();

    setMetric(elValTair, s.tair, "°C", 1);
    setMetric(elValRh,   s.rh,   "%", 0);
    setMetric(elValVpd,  s.vpd,  "kPa", 2);
    setMetric(elValRad,  s.rad,  "lux", 0);
    setMetric(elValSoil1,s.soil1,"%", 0);

    // Actualizar setpoints desde el estado
    if(typeof s.vpdMin === "number"){
      cfgSetpoints.vpdMin = s.vpdMin;
      spVpdMin.value = s.vpdMin.toFixed(2);
    }
    if(typeof s.vpdMax === "number"){
      cfgSetpoints.vpdMax = s.vpdMax;
      spVpdMax.value = s.vpdMax.toFixed(2);
    }
    if(typeof s.soilMin === "number"){
      cfgSetpoints.soilMin = s.soilMin;
      spSoilMin.value = s.soilMin.toFixed(0);
    }
    if(typeof s.soilMax === "number"){
      cfgSetpoints.soilMax = s.soilMax;
      spSoilMax.value = s.soilMax.toFixed(0);
    }
    if(typeof s.radMax === "number"){
      cfgSetpoints.radMax = s.radMax;
      spRadMax.value = s.radMax.toFixed(0);
    }

    // Actualizar bandas
    setBandStatus(elBandRh,   s.rh,   40, 70);
    setBandStatus(elBandVpd,  s.vpd,  cfgSetpoints.vpdMin, cfgSetpoints.vpdMax);
    setBandStatus(elBandSoil1,s.soil1,cfgSetpoints.soilMin,cfgSetpoints.soilMax);
    setRadStatus(elBandRad,   s.rad,  cfgSetpoints.radMax);

    if(typeof s.systemOn === "boolean") currentSystemOn = s.systemOn;
    if(typeof s.mode === "string") currentMode = s.mode.toUpperCase();
    setControlStatus();

    // Estado de válvula
    if(typeof s.s1 === "boolean"){
      valve1State = s.s1;
      applyValveUi();
    }
  }

  // ============= VÁLVULA UI =====================
  function applyValveUi(){
    if(valve1State){
      elSwitchValve1.classList.add("on");
      elTxtValve1.textContent = "ON";
    }else{
      elSwitchValve1.classList.remove("on");
      elTxtValve1.textContent = "OFF";
    }
  }

  // ============= HISTÓRICO (Chart.js) ==========
  function initCharts(){
    const ctx1 = $("chartTempHum").getContext("2d");
    const ctx2 = $("chartSoil").getContext("2d");

    chartTempHum = new Chart(ctx1,{
      type:"line",
      data:{
        labels:[],
        datasets:[
          {
            label:"Temperatura (°C)",
            data:[],
            borderColor:"rgba(60,242,165,1)",
            backgroundColor:"rgba(60,242,165,0.12)",
            borderWidth:1.4,
            tension:0.25,
            pointRadius:0
          },
          {
            label:"Humedad relativa (%)",
            data:[],
            borderColor:"rgba(255,115,179,1)",
            backgroundColor:"rgba(255,115,179,0.12)",
            borderWidth:1.4,
            tension:0.25,
            pointRadius:0
          }
        ]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{labels:{color:"#cfd5ff",font:{size:10}}},
          tooltip:{mode:"index",intersect:false}
        },
        interaction:{mode:"index",intersect:false},
        scales:{
          x:{ticks:{color:"#8d98c9",maxTicksLimit:8,font:{size:9}},
             grid:{color:"rgba(69,76,120,0.3)"}},
          y:{ticks:{color:"#8d98c9",font:{size:9}},
             grid:{color:"rgba(69,76,120,0.25)"}}
        }
      }
    });

    chartSoil = new Chart(ctx2,{
      type:"line",
      data:{
        labels:[],
        datasets:[{
          label:"Humedad suelo (%)",
          data:[],
          borderColor:"rgba(104,181,255,1)",
          backgroundColor:"rgba(104,181,255,0.12)",
          borderWidth:1.4,
          tension:0.25,
          pointRadius:0
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{labels:{color:"#cfd5ff",font:{size:10}}},
          tooltip:{mode:"index",intersect:false}
        },
        interaction:{mode:"index",intersect:false},
        scales:{
          x:{ticks:{color:"#8d98c9",maxTicksLimit:8,font:{size:9}},
             grid:{color:"rgba(69,76,120,0.3)"}},
          y:{ticks:{color:"#8d98c9",font:{size:9}},
             grid:{color:"rgba(69,76,120,0.25)"}}
        }
      }
    });
  }

  async function loadHistory(days){
    if(historyLoading) return;
    historyLoading = true;

    try{
      if(!HISTORY_API_BASE){
        addLog("Histórico no configurado (URL backend).");
        return;
      }
      const resp = await fetch(`${HISTORY_API_BASE}/api/historial?dias=${days}`);
      if(!resp.ok) throw new Error("HTTP " + resp.status);
      const json = await resp.json();

      let data;
      if(Array.isArray(json)) data = json;
      else if(Array.isArray(json.rows)) data = json.rows;
      else if(Array.isArray(json.data)) data = json.data;
      else throw new Error("Formato inesperado de historial");

      const labels = data.map(r=>{
        const d = new Date(r.ts);
        return `${d.getDate()}/${d.getMonth()+1} ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
      });

      const temp = data.map(r => r.tair);
      const hum  = data.map(r => r.rh);
      const soil = data.map(r => r.soil1);

      chartTempHum.data.labels = labels;
      chartTempHum.data.datasets[0].data = temp;
      chartTempHum.data.datasets[1].data = hum;
      chartTempHum.update("none");

      chartSoil.data.labels = labels;
      chartSoil.data.datasets[0].data = soil;
      chartSoil.update("none");

      addLog(`Histórico cargado (${days} día(s), ${data.length} muestras).`);
    }catch(e){
      console.error("Error cargando histórico:", e);
      addLog("Error al cargar histórico: " + e.message);
    }finally{
      historyLoading = false;
    }
  }

  // ================= EVENTOS UI =================
  elBtnControlAuto.addEventListener("click",()=>{
    publishCmd({type:"CONTROL_ENABLE",value:true});
    publishCmd({type:"MODE",value:"AUTO"});
    currentSystemOn = true;
    currentMode = "AUTO";
    setControlStatus();
  });

  elBtnStop.addEventListener("click",()=>{
    publishCmd({type:"CONTROL_ENABLE",value:false});
    currentSystemOn = false;
    setControlStatus();
  });

  elBtnModeManual.addEventListener("click",()=>{
    publishCmd({type:"MODE",value:"MANUAL"});
    currentMode = "MANUAL";
    setControlStatus();
  });

  elBtnModeAuto.addEventListener("click",()=>{
    publishCmd({type:"MODE",value:"AUTO"});
    currentMode = "AUTO";
    setControlStatus();
  });

  elSwitchValve1.addEventListener("click",()=>{
    valve1State = !valve1State;
    publishCmd({type:"VALVE",sector:"s1",value:valve1State});
    applyValveUi();
  });

  $("btnClearLog").addEventListener("click",()=>{
    elLogList.innerHTML = "";
  });

  btnSpVpd.addEventListener("click",()=>{
    const min = parseFloat(spVpdMin.value);
    const max = parseFloat(spVpdMax.value);
    if(!isNaN(min)){
      cfgSetpoints.vpdMin = min;
      publishCmd({type:"SETPOINT",name:"vpdMin",value:min});
    }
    if(!isNaN(max)){
      cfgSetpoints.vpdMax = max;
      publishCmd({type:"SETPOINT",name:"vpdMax",value:max});
    }
  });

  btnSpSoil.addEventListener("click",()=>{
    const min = parseFloat(spSoilMin.value);
    const max = parseFloat(spSoilMax.value);
    if(!isNaN(min)){
      cfgSetpoints.soilMin = min;
      publishCmd({type:"SETPOINT",name:"soilMin",value:min});
    }
    if(!isNaN(max)){
      cfgSetpoints.soilMax = max;
      publishCmd({type:"SETPOINT",name:"soilMax",value:max});
    }
  });

  btnSpRad.addEventListener("click",()=>{
    const max = parseFloat(spRadMax.value);
    if(!isNaN(max)){
      cfgSetpoints.radMax = max;
      publishCmd({type:"SETPOINT",name:"radMax",value:max});
    }
  });

  btnRange24h.addEventListener("click",()=>{
    btnRange24h.classList.add("active");
    btnRange3d.classList.remove("active");
    currentHistoryDays = 1;
    loadHistory(currentHistoryDays);
  });

  btnRange3d.addEventListener("click",()=>{
    btnRange3d.classList.add("active");
    btnRange24h.classList.remove("active");
    currentHistoryDays = 3;
    loadHistory(currentHistoryDays);
  });

  // ======== ARRANQUE ============================
  window.addEventListener("load",()=>{
    setControlStatus();
    setMqttStatus(false);
    updateEsp32Status();
    connectMqtt();
    initCharts();

    // Inicializar setpoints visuales por defecto
    spVpdMin.value = cfgSetpoints.vpdMin;
    spVpdMax.value = cfgSetpoints.vpdMax;
    spSoilMin.value = cfgSetpoints.soilMin;
    spSoilMax.value = cfgSetpoints.soilMax;
    spRadMax.value  = cfgSetpoints.radMax;

    currentHistoryDays = 1;
    loadHistory(currentHistoryDays);

    // refrescar histórico automáticamente cada 30 s
    setInterval(()=>{
      if(document.visibilityState === "visible"){
        loadHistory(currentHistoryDays);
      }
    },30000);

    // revisar estado ESP32 cada 5 s
    setInterval(updateEsp32Status,5000);
  });
</script>
</body>
</html>
