<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Riego Inteligente – Palta Fuerte (Prototipo 1 sector)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <style>
    :root {
      --bg: #050814;
      --bg-card: #111727;
      --bg-card-soft: #161d30;
      --accent: #3cf2a5;
      --accent-soft: rgba(60, 242, 165, 0.15);
      --accent-red: #ff4b5c;
      --accent-red-soft: rgba(255, 75, 92, 0.15);
      --text-main: #f4f7ff;
      --text-soft: #a9b2d0;
      --border-soft: #252c42;
      --chip-bg: #171f32;
      --chip-soft: #23314a;
      --shadow-soft: 0 18px 45px rgba(0, 0, 0, 0.55);
      --good: #48e39a;
      --warn: #ffcc4d;
      --bad: #ff4b5c;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(circle at top left, #14213b 0, #050814 40%, #01020a 100%);
      color: var(--text-main);
      overflow-x: hidden;
    }

    body {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 24px;
    }

    .app {
      width: 100%;
      max-width: 1360px;
      min-height: 680px;
      border-radius: 18px;
      background: radial-gradient(circle at top left, #161e35 0, #070a16 35%, #050814 100%);
      box-shadow: var(--shadow-soft);
      padding: 22px 24px 18px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      border: 1px solid #20263a;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .title {
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .subtitle {
      font-size: 12px;
      color: var(--text-soft);
    }

    .status-group {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 999px;
      background: var(--chip-bg);
      border: 1px solid var(--border-soft);
      font-size: 11px;
      color: var(--text-soft);
    }

    .status-dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
    }

    .dot-red {
      background: var(--accent-red);
      box-shadow: 0 0 0 4px var(--accent-red-soft);
    }
    .dot-amber {
      background: var(--warn);
      box-shadow: 0 0 0 4px rgba(255, 204, 77, 0.25);
    }
    .dot-green {
      background: var(--accent);
      box-shadow: 0 0 0 4px var(--accent-soft);
    }

    .status-label-strong {
      font-weight: 500;
      color: var(--text-main);
    }

    main {
      display: grid;
      grid-template-columns: 1.1fr 1.1fr 1.1fr;
      gap: 14px;
      align-items: stretch;
    }

    .card {
      background: linear-gradient(135deg, #101626 0, #090e1a 100%);
      border-radius: 18px;
      padding: 14px 16px 16px;
      border: 1px solid var(--border-soft);
      box-shadow: 0 14px 35px rgba(0, 0, 0, 0.55);
      display: flex;
      flex-direction: column;
      gap: 12px;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -40%;
      background: radial-gradient(circle at 10% 0, rgba(87, 204, 255, 0.04), transparent 55%);
      opacity: 0.9;
      pointer-events: none;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      position: relative;
      z-index: 1;
    }

    .card-title {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .card-sub {
      font-size: 11px;
      color: var(--text-soft);
    }

    .badge {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 999px;
      background: var(--chip-soft);
      color: var(--text-soft);
      border: 1px solid var(--border-soft);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .grid-metrics {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      z-index: 1;
      position: relative;
    }

    .metric-card {
      background: var(--bg-card);
      border-radius: 14px;
      padding: 9px 9px 10px;
      border: 1px solid rgba(52, 65, 109, 0.85);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .metric-label {
      font-size: 11px;
      color: var(--text-soft);
    }

    .metric-value-row {
      display: flex;
      align-items: baseline;
      gap: 4px;
    }

    .metric-value {
      font-size: 19px;
      font-weight: 600;
    }

    .metric-unit {
      font-size: 11px;
      color: var(--text-soft);
    }

    .metric-tag {
      font-size: 10px;
      color: var(--good);
    }
    .metric-tag.warn {
      color: var(--warn);
    }
    .metric-tag.bad {
      color: var(--bad);
    }

    .metric-footer {
      font-size: 10px;
      color: var(--text-soft);
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 8px;
      border-radius: 999px;
      background: var(--chip-bg);
      font-size: 10px;
      color: var(--text-soft);
      border: 1px solid var(--border-soft);
    }

    .chip-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--accent);
    }

    .btn-pill {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: var(--chip-bg);
      color: var(--text-soft);
      font-size: 11px;
      padding: 7px 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.15s ease-out;
    }

    .btn-pill.primary {
      background: var(--accent-soft);
      border-color: var(--accent);
      color: var(--text-main);
    }

    .btn-pill.danger {
      background: var(--accent-red-soft);
      border-color: var(--accent-red);
      color: var(--text-main);
    }

    .btn-pill.active {
      box-shadow: 0 0 0 1px var(--accent);
    }

    .btn-pill:hover {
      transform: translateY(-1px);
      box-shadow: 0 7px 18px rgba(0, 0, 0, 0.4);
    }

    .btn-group {
      display: inline-flex;
      padding: 3px;
      border-radius: 999px;
      background: var(--chip-bg);
      border: 1px solid var(--border-soft);
    }

    .btn-toggle {
      border: none;
      outline: none;
      padding: 5px 12px;
      font-size: 11px;
      cursor: pointer;
      border-radius: 999px;
      background: transparent;
      color: var(--text-soft);
      transition: all 0.15s;
    }

    .btn-toggle.active {
      background: var(--accent-soft);
      color: var(--text-main);
    }

    .btn-toggle + .btn-toggle {
      margin-left: 4px;
    }

    .pill-small {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 999px;
      background: var(--chip-bg);
      border: 1px solid var(--border-soft);
      color: var(--text-soft);
    }

    .valve-card {
      background: var(--bg-card);
      border-radius: 15px;
      padding: 10px 10px 9px;
      border: 1px solid rgba(52, 65, 109, 0.9);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .valve-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .valve-title {
      font-size: 12px;
      font-weight: 500;
    }

    .valve-sub {
      font-size: 11px;
      color: var(--text-soft);
    }

    .switch {
      position: relative;
      width: 46px;
      height: 24px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background-color: #22293c;
      transition: 0.2s;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 17px;
      width: 17px;
      left: 3px;
      top: 2px;
      background-color: #ffffff;
      transition: 0.2s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: rgba(60, 242, 165, 0.12);
      border-color: var(--accent);
    }

    input:checked + .slider:before {
      transform: translateX(20px);
      background: var(--accent);
      box-shadow: 0 0 0 5px rgba(60, 242, 165, 0.25);
    }

    .logs {
      flex: 1;
      min-height: 180px;
      max-height: 220px;
      overflow-y: auto;
      margin-top: 4px;
      padding-right: 6px;
      font-size: 11px;
    }

    .log-entry {
      padding: 3px 0;
      border-bottom: 1px solid rgba(35, 45, 73, 0.8);
      display: flex;
      gap: 8px;
      color: var(--text-soft);
    }

    .log-time {
      color: #737fa1;
      min-width: 40px;
    }

    .log-msg {
      flex: 1;
    }

    .btn-small {
      font-size: 10px;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: var(--chip-bg);
      color: var(--text-soft);
      cursor: pointer;
    }

    .btn-small:hover {
      background: var(--chip-soft);
    }

    .history-section {
      margin-top: 4px;
      background: linear-gradient(135deg, #101626 0, #090e1a 100%);
      border-radius: 16px;
      padding: 12px 16px 14px;
      border: 1px solid var(--border-soft);
      box-shadow: 0 14px 35px rgba(0, 0, 0, 0.5);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
    }

    .history-title {
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .history-sub {
      font-size: 11px;
      color: var(--text-soft);
    }

    .history-body {
      display: grid;
      grid-template-columns: 1.3fr 1.1fr;
      gap: 16px;
      align-items: stretch;
      margin-top: 4px;
    }

    .chart-card {
      background: var(--bg-card-soft);
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      padding: 9px 10px 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-height: 170px;
    }

    .chart-title {
      font-size: 11px;
      color: var(--text-soft);
    }

    .chart-container {
      position: relative;
      flex: 1;
      min-height: 130px;
    }

    canvas {
      width: 100% !important;
      height: 100% !important;
    }

    footer {
      margin-top: 4px;
      font-size: 10px;
      color: var(--text-soft);
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    @media (max-width: 1100px) {
      body {
        padding: 10px;
      }
      .app {
        padding: 16px;
      }
      main {
        grid-template-columns: 1fr;
      }
      .history-body {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="title-block">
      <div class="title">Sistema de riego inteligente – Palta fuerte</div>
      <div class="subtitle">Parcela piloto – Prototipo 1 sector (ESP32 + IoT)</div>
    </div>

    <div class="status-group">
      <div class="status-pill" id="statusControl">
        <span class="status-dot dot-red" id="dotControl"></span>
        <span class="status-label-strong" id="labelControl">Control detenido</span>
        <span>Modo actual: <span id="labelMode">Manual</span></span>
      </div>

      <div class="status-pill" id="statusMqtt">
        <span class="status-dot dot-amber" id="dotMqtt"></span>
        <span>MQTT: <span id="labelMqtt">Conectando...</span></span>
      </div>

      <div class="status-pill" id="statusEsp32">
        <span class="status-dot dot-amber" id="dotEsp32"></span>
        <span>ESP32: <span id="labelEsp32">Sin datos recientes</span></span>
      </div>
    </div>
  </header>

  <main>
    <!-- MONITOREO TIEMPO REAL -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Monitoreo en tiempo real</div>
          <div class="card-sub">Microclima + humedad de suelo</div>
        </div>
        <div class="badge">Datos desde ESP32</div>
      </div>

      <div class="grid-metrics">
        <!-- Temperatura aire -->
        <div class="metric-card">
          <div class="metric-label">Temperatura aire</div>
          <div class="metric-value-row">
            <div class="metric-value" id="tairValue">--.-</div>
            <div class="metric-unit">°C</div>
          </div>
          <div class="metric-tag" id="tairTag">Sin datos</div>
          <div class="metric-footer">Rango sugerido: 18–30 °C</div>
        </div>

        <!-- Humedad relativa -->
        <div class="metric-card">
          <div class="metric-label">Humedad relativa</div>
          <div class="metric-value-row">
            <div class="metric-value" id="rhValue">--</div>
            <div class="metric-unit">%</div>
          </div>
          <div class="metric-tag" id="rhTag">Sin datos</div>
          <div class="metric-footer">Objetivo: 40–70 %</div>
        </div>

        <!-- VPD -->
        <div class="metric-card">
          <div class="metric-label">Déficit de presión de vapor (VPD)</div>
          <div class="metric-value-row">
            <div class="metric-value" id="vpdValue">--.-</div>
            <div class="metric-unit">kPa</div>
          </div>
          <div class="metric-tag" id="vpdTag">Sin datos</div>
          <div class="metric-footer">Banda objetivo: 0.6 – 1.2 kPa</div>
        </div>

        <!-- Radiación -->
        <div class="metric-card">
          <div class="metric-label">Radiación en copa</div>
          <div class="metric-value-row">
            <div class="metric-value" id="radValue">--</div>
            <div class="metric-unit">lux</div>
          </div>
          <div class="metric-tag" id="radTag">Sin datos</div>
          <div class="metric-footer">Límite para riego: &lt; 60 000 lux</div>
        </div>

        <!-- Humedad suelo único -->
        <div class="metric-card">
          <div class="metric-label">Humedad de suelo S1 (sector único)</div>
          <div class="metric-value-row">
            <div class="metric-value" id="soil1Value">--</div>
            <div class="metric-unit">%</div>
          </div>
          <div class="metric-tag" id="soil1Tag">Sin datos</div>
          <div class="metric-footer">Banda objetivo: 30–60 %</div>
        </div>

        <!-- Estado general -->
        <div class="metric-card">
          <div class="metric-label">Estado general</div>
          <div class="metric-value-row">
            <div class="metric-value" id="globalState">--</div>
          </div>
          <div class="metric-tag" id="globalTag">Sin datos</div>
          <div class="metric-footer" id="globalFooter">Esperando datos del ESP32…</div>
        </div>
      </div>
    </section>

    <!-- CONTROL PRINCIPAL -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Control principal</div>
          <div class="card-sub">Modo de operación + lógica VPD + suelo</div>
        </div>
      </div>

      <div style="display:flex; flex-direction:column; gap:10px; z-index:1; position:relative;">
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn-pill primary" id="btnEnable">
            Activar control automático
          </button>
          <button class="btn-pill danger" id="btnStop">
            Paro de emergencia
          </button>
        </div>

        <div>
          <div class="card-sub" style="margin-bottom:6px;">Selección de modo (global)</div>
          <div class="btn-group">
            <button class="btn-toggle active" id="btnModeManual">Manual</button>
            <button class="btn-toggle" id="btnModeAuto">Automático</button>
          </div>
        </div>

        <div>
          <div class="card-sub" style="margin-bottom:4px;">Alarmas activas (sensores, VPD y riego)</div>
          <div class="pill-small" id="alarmsLabel">Sin alarmas activas.</div>
        </div>

        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn-pill" id="btnTestAlarm">Generar alarma de prueba</button>
          <button class="btn-pill" id="btnAckAlarms">Reconocer todas</button>
        </div>
      </div>
    </section>

    <!-- CONTROL DE SECTOR ÚNICO -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Control de sector</div>
          <div class="card-sub">Válvula de riego único (Sector 1)</div>
        </div>
        <div class="badge">Modo actual: <span id="badgeMode">Manual</span></div>
      </div>

      <div style="display:flex; flex-direction:column; gap:10px; z-index:1; position:relative;">
        <div class="valve-card">
          <div class="valve-info">
            <div class="valve-title">Válvula Sector 1</div>
            <div class="valve-sub">Hilera principal (10 m aprox.)</div>
          </div>
          <label class="switch">
            <input type="checkbox" id="valveS1" data-sector="s1" />
            <span class="slider"></span>
          </label>
        </div>

        <div class="card-sub" style="margin-top:4px;">Eventos recientes</div>
        <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
          <button class="btn-small" id="btnClearLog">Limpiar log</button>
          <span style="font-size:10px; color:var(--text-soft);" id="logHint">Mensajes MQTT y cambios de estado.</span>
        </div>
        <div class="logs" id="logContainer"></div>
      </div>
    </section>
  </main>

  <!-- HISTÓRICO DE VARIABLES -->
  <section class="history-section">
    <div class="history-header">
      <div>
        <div class="history-title">Histórico de variables</div>
        <div class="history-sub">Últimos días desde Supabase (bridge Node en Render)</div>
      </div>
      <div class="btn-group">
        <button class="btn-toggle active" id="btnRange24h">Últimas 24 h</button>
        <button class="btn-toggle" id="btnRange3d">Últimos 3 días</button>
      </div>
    </div>

    <div class="history-body">
      <div class="chart-card">
        <div class="chart-title">Temperatura y humedad relativa</div>
        <div class="chart-container">
          <canvas id="chartTempHum"></canvas>
        </div>
      </div>

      <div class="chart-card">
        <div class="chart-title">Humedad de suelo (Sector único)</div>
        <div class="chart-container">
          <canvas id="chartSoil"></canvas>
        </div>
      </div>
    </div>
  </section>

  <footer>
    <span>HMI Web – Prototipo piloto 1 sector (90–120 m²).</span>
    <span>Conectado a ESP32 vía MQTT (riego/estado &amp; riego/cmd) + histórico vía Supabase.</span>
  </footer>
</div>

<!-- Librerías externas -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<script>
  // ================== CONFIGURACIÓN ==================
  const MQTT_BROKER_URL = "wss://broker.emqx.io:8084/mqtt";
  const MQTT_TOPIC_STATE = "riego/estado";
  const MQTT_TOPIC_CMD   = "riego/cmd";

  // BACKEND histórico (Render)
  const HISTORY_API_BASE =
    (location.protocol === "file:" || location.hostname === "localhost")
      ? "http://localhost:3000"
      : "https://riego-bridge.onrender.com"; // <-- pon aquí tu URL de Render si es distinta

  // ================== ESTADO LOCAL HMI ==================
  let mqttClient = null;
  let lastEsp32Ts = 0;
  let controlEnabled = false;
  let currentMode = "MANUAL";
  let lastState = null;

  // ================== ELEMENTOS DOM ==================
  const dotControl = document.getElementById("dotControl");
  const labelControl = document.getElementById("labelControl");
  const labelMode = document.getElementById("labelMode");
  const badgeMode = document.getElementById("badgeMode");
  const dotMqtt = document.getElementById("dotMqtt");
  const labelMqtt = document.getElementById("labelMqtt");
  const dotEsp32 = document.getElementById("dotEsp32");
  const labelEsp32 = document.getElementById("labelEsp32");

  const tairValue = document.getElementById("tairValue");
  const rhValue   = document.getElementById("rhValue");
  const vpdValue  = document.getElementById("vpdValue");
  const radValue  = document.getElementById("radValue");
  const soil1Value = document.getElementById("soil1Value");

  const tairTag = document.getElementById("tairTag");
  const rhTag   = document.getElementById("rhTag");
  const vpdTag  = document.getElementById("vpdTag");
  const radTag  = document.getElementById("radTag");
  const soil1Tag= document.getElementById("soil1Tag");

  const globalState = document.getElementById("globalState");
  const globalTag   = document.getElementById("globalTag");
  const globalFooter= document.getElementById("globalFooter");

  const btnEnable = document.getElementById("btnEnable");
  const btnStop   = document.getElementById("btnStop");
  const btnModeManual = document.getElementById("btnModeManual");
  const btnModeAuto   = document.getElementById("btnModeAuto");

  const alarmsLabel = document.getElementById("alarmsLabel");
  const btnTestAlarm = document.getElementById("btnTestAlarm");
  const btnAckAlarms = document.getElementById("btnAckAlarms");

  const switchS1 = document.getElementById("valveS1");
  const logContainer = document.getElementById("logContainer");
  const btnClearLog = document.getElementById("btnClearLog");

  const btnRange24h = document.getElementById("btnRange24h");
  const btnRange3d  = document.getElementById("btnRange3d");

  // ================== UTILIDADES ==================
  function setControlStatus() {
    if (controlEnabled) {
      dotControl.classList.remove("dot-red");
      dotControl.classList.add("dot-green");
      labelControl.textContent = "Control activo";
    } else {
      dotControl.classList.remove("dot-green");
      dotControl.classList.add("dot-red");
      labelControl.textContent = "Control detenido";
    }
    labelMode.textContent = currentMode === "AUTO" ? "Automático" : "Manual";
    badgeMode.textContent = labelMode.textContent;
  }

  function setMqttStatus(connected) {
    if (connected) {
      dotMqtt.classList.remove("dot-red", "dot-amber");
      dotMqtt.classList.add("dot-green");
      labelMqtt.textContent = "Conectado al broker MQTT";
    } else {
      dotMqtt.classList.remove("dot-green");
      dotMqtt.classList.add("dot-red");
      labelMqtt.textContent = "Desconectado";
    }
  }

  function updateEsp32Status() {
    const now = Date.now();
    if (lastEsp32Ts === 0) {
      dotEsp32.classList.remove("dot-green", "dot-red");
      dotEsp32.classList.add("dot-amber");
      labelEsp32.textContent = "Sin datos recientes";
    } else if (now - lastEsp32Ts < 15000) {
      dotEsp32.classList.remove("dot-amber", "dot-red");
      dotEsp32.classList.add("dot-green");
      labelEsp32.textContent = "En línea";
    } else {
      dotEsp32.classList.remove("dot-green");
      dotEsp32.classList.add("dot-amber");
      labelEsp32.textContent = "Sin actualización reciente";
    }
  }
  setInterval(updateEsp32Status, 2000);

  function addLog(msg) {
    const now = new Date();
    const hh = String(now.getHours()).padStart(2, "0");
    const mm = String(now.getMinutes()).padStart(2, "0");
    const time = `${hh}:${mm}`;

    const div = document.createElement("div");
    div.className = "log-entry";
    div.innerHTML = `<div class="log-time">${time}</div><div class="log-msg">${msg}</div>`;
    logContainer.prepend(div);
    const maxEntries = 80;
    while (logContainer.children.length > maxEntries) {
      logContainer.removeChild(logContainer.lastChild);
    }
  }

  // ================== MQTT ==================
  function connectMqtt() {
    const clientId = "HMI-Web-" + Math.random().toString(16).substr(2, 8);
    mqttClient = mqtt.connect(MQTT_BROKER_URL, {
      clientId,
      clean: true,
      reconnectPeriod: 3000,
      connectTimeout: 4000
    });

    mqttClient.on("connect", () => {
      setMqttStatus(true);
      addLog("Conectado al broker MQTT.");
      mqttClient.subscribe(MQTT_TOPIC_STATE, (err) => {
        if (!err) {
          addLog("Suscrito a riego/estado.");
        }
      });
    });

    mqttClient.on("reconnect", () => {
      setMqttStatus(false);
      addLog("Reintentando conexión MQTT...");
    });

    mqttClient.on("close", () => {
      setMqttStatus(false);
    });

    mqttClient.on("error", (err) => {
      setMqttStatus(false);
      console.error("MQTT error:", err);
    });

    mqttClient.on("message", (topic, payload) => {
      if (topic === MQTT_TOPIC_STATE) {
        try {
          const text = new TextDecoder().decode(payload);
          const data = JSON.parse(text);
          lastEsp32Ts = Date.now();
          lastState = data;
          updateUiFromState(data);
          addLog("Mensaje recibido en riego/estado.");
        } catch (e) {
          console.error("Error parseando estado:", e);
        }
      }
    });
  }

  function publishCmd(obj) {
    if (!mqttClient || !mqttClient.connected) return;
    const payload = JSON.stringify(obj);
    mqttClient.publish(MQTT_TOPIC_CMD, payload);
    addLog(`CMD → ${payload}`);
  }

  // ================== ACTUALIZAR UI ESTADO ==================
  function updateUiFromState(s) {
    // Control
    controlEnabled = !!s.systemOn;
    currentMode = (s.mode || "MANUAL").toUpperCase();
    setControlStatus();

    // Valores
    const tair = s.tair ?? NaN;
    const rh   = s.rh   ?? NaN;
    const vpd  = s.vpd  ?? NaN;
    const rad  = s.rad  ?? NaN;
    const soil1= s.soil1?? NaN;

    if (!isNaN(tair)) {
      tairValue.textContent = tair.toFixed(1);
      let tag = "Rango óptimo";
      let cls = "";
      if (tair < 18 || tair > 30) { tag = "Fuera de rango"; cls = "bad"; }
      else if (tair < 20 || tair > 28) { tag = "En el límite"; cls = "warn"; }
      tairTag.textContent = tag;
      tairTag.className = "metric-tag " + cls;
    }

    if (!isNaN(rh)) {
      rhValue.textContent = rh.toFixed(0);
      let tag = "En banda";
      let cls = "";
      if (rh < 40 || rh > 80) { tag = "Fuera de banda"; cls = "bad"; }
      else if (rh < 45 || rh > 70) { tag = "Cercano al límite"; cls = "warn"; }
      rhTag.textContent = tag;
      rhTag.className = "metric-tag " + cls;
    }

    if (!isNaN(vpd)) {
      vpdValue.textContent = vpd.toFixed(2);
      let tag = "Banda óptima";
      let cls = "";
      if (vpd < 0.3 || vpd > 1.5) { tag = "Fuera de banda"; cls = "bad"; }
      else if (vpd < 0.6 || vpd > 1.2) { tag = "Cercano al límite"; cls = "warn"; }
      vpdTag.textContent = tag;
      vpdTag.className = "metric-tag " + cls;
    }

    if (!isNaN(rad)) {
      radValue.textContent = rad.toFixed(0);
      let tag = "Riego habilitado";
      let cls = "";
      if (rad > 60000) { tag = "Radiación alta para riego"; cls = "warn"; }
      radTag.textContent = tag;
      radTag.className = "metric-tag " + cls;
    }

    if (!isNaN(soil1)) {
      soil1Value.textContent = soil1.toFixed(0);
      let tag = "En banda";
      let cls = "";
      if (soil1 < 20) { tag = "Suelo muy seco"; cls = "bad"; }
      else if (soil1 < 30) { tag = "Suelo seco"; cls = "warn"; }
      else if (soil1 > 70) { tag = "Suelo muy húmedo"; cls = "bad"; }
      else if (soil1 > 60) { tag = "Suelo húmedo (alto)"; cls = "warn"; }
      soil1Tag.textContent = tag;
      soil1Tag.className = "metric-tag " + cls;
    }

    // Estado general sencillo
    let global = "Detenido";
    let globalCls = "";
    let globalDesc = "";

    if (!controlEnabled) {
      global = "Detenido";
      globalDesc = "Esperando activación de control.";
    } else if (currentMode === "MANUAL") {
      global = "Manual";
      globalDesc = "Control activado, operación manual.";
    } else {
      global = "Automático";
      if (!isNaN(soil1) && soil1 < 30) {
        globalDesc = "Riego probablemente requerido (suelo seco).";
        globalCls = "warn";
      } else {
        globalDesc = "Control automático en banda.";
        globalCls = "";
      }
    }

    globalState.textContent = global;
    globalTag.textContent = currentMode === "AUTO" ? "Esperando condiciones para riego" : "Operación manual";
    globalTag.className = "metric-tag " + globalCls;
    globalFooter.textContent = globalDesc;

    // Válvula sector 1
    const s1 = !!s.s1;
    switchS1.checked = s1;
  }

  // ================== EVENTOS UI ==================
  btnEnable.addEventListener("click", () => {
    publishCmd({ type: "CONTROL_ENABLE", value: true });
    controlEnabled = true;
    setControlStatus();
  });

  btnStop.addEventListener("click", () => {
    publishCmd({ type: "CONTROL_ENABLE", value: false });
    controlEnabled = false;
    setControlStatus();
    addLog("Paro de emergencia solicitado.");
  });

  btnModeManual.addEventListener("click", () => {
    currentMode = "MANUAL";
    btnModeManual.classList.add("active");
    btnModeAuto.classList.remove("active");
    publishCmd({ type: "MODE", value: "MANUAL" });
    setControlStatus();
  });

  btnModeAuto.addEventListener("click", () => {
    currentMode = "AUTO";
    btnModeAuto.classList.add("active");
    btnModeManual.classList.remove("active");
    publishCmd({ type: "MODE", value: "AUTO" });
    setControlStatus();
  });

  switchS1.addEventListener("change", () => {
    const val = switchS1.checked;
    publishCmd({ type: "VALVE", sector: "s1", value: val });
  });

  btnClearLog.addEventListener("click", () => {
    logContainer.innerHTML = "";
  });

  btnTestAlarm.addEventListener("click", () => {
    alarmsLabel.textContent = "Alarma de prueba generada desde HMI.";
    alarmsLabel.style.color = "#ffcc4d";
    addLog("Alarma de prueba generada.");
  });

  btnAckAlarms.addEventListener("click", () => {
    alarmsLabel.textContent = "Sin alarmas activas.";
    alarmsLabel.style.color = "var(--text-soft)";
    addLog("Alarmas reconocidas.");
  });

  // ================== CHARTS (HISTÓRICO) ==================
  let chartTempHum, chartSoil;

  function initCharts() {
    const ctx1 = document.getElementById("chartTempHum").getContext("2d");
    const ctx2 = document.getElementById("chartSoil").getContext("2d");

    chartTempHum = new Chart(ctx1, {
      type: "line",
      data: {
        labels: [],
        datasets: [
          {
            label: "Temperatura (°C)",
            data: [],
            tension: 0.25,
            borderWidth: 1.6,
            pointRadius: 0,
          },
          {
            label: "Humedad relativa (%)",
            data: [],
            tension: 0.25,
            borderWidth: 1.2,
            pointRadius: 0,
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: "index", intersect: false },
        plugins: {
          legend: { display: true, labels: { color: "#c5cdee", font: { size: 10 } } },
          tooltip: { enabled: true }
        },
        scales: {
          x: {
            ticks: { color: "#7f88a7", maxRotation: 0, font: { size: 9 } },
            grid: { color: "rgba(65,72,104,0.5)" }
          },
          y: {
            ticks: { color: "#7f88a7", font: { size: 9 } },
            grid: { color: "rgba(65,72,104,0.4)" }
          }
        }
      }
    });

    chartSoil = new Chart(ctx2, {
      type: "line",
      data: {
        labels: [],
        datasets: [
          {
            label: "Humedad suelo (%)",
            data: [],
            tension: 0.25,
            borderWidth: 1.6,
            pointRadius: 0,
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: "index", intersect: false },
        plugins: {
          legend: { display: true, labels: { color: "#c5cdee", font: { size: 10 } } },
          tooltip: { enabled: true }
        },
        scales: {
          x: {
            ticks: { color: "#7f88a7", maxRotation: 0, font: { size: 9 } },
            grid: { color: "rgba(65,72,104,0.5)" }
          },
          y: {
            ticks: { color: "#7f88a7", font: { size: 9 } },
            grid: { color: "rgba(65,72,104,0.4)" }
          }
        }
      }
    });
  }

  async function loadHistory(days) {
    try {
      if (!HISTORY_API_BASE || HISTORY_API_BASE.includes("TU_BACKEND_URL")) {
        addLog("Histórico no configurado (URL backend).");
        return;
      }
      const resp = await fetch(`${HISTORY_API_BASE}/api/historial?dias=${days}`);
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      const data = await resp.json();

      const labels = data.map(r => {
        const d = new Date(r.ts);
        return `${d.getDate()}/${d.getMonth()+1} ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
      });

      const temp = data.map(r => r.tair);
      const hum  = data.map(r => r.rh);
      const soil = data.map(r => r.soil1);

      chartTempHum.data.labels = labels;
      chartTempHum.data.datasets[0].data = temp;
      chartTempHum.data.datasets[1].data = hum;
      chartTempHum.update("none");

      chartSoil.data.labels = labels;
      chartSoil.data.datasets[0].data = soil;
      chartSoil.update("none");

      addLog(`Histórico cargado (${days} día(s), ${data.length} muestras).`);
    } catch (e) {
      console.error("Error cargando histórico:", e);
      addLog("Error al cargar histórico: " + e.message);
    }
  }

  btnRange24h.addEventListener("click", () => {
    btnRange24h.classList.add("active");
    btnRange3d.classList.remove("active");
    loadHistory(1);
  });
  btnRange3d.addEventListener("click", () => {
    btnRange3d.classList.add("active");
    btnRange24h.classList.remove("active");
    loadHistory(3);
  });

  // ================== ARRANQUE ==================
  window.addEventListener("load", () => {
    setControlStatus();
    setMqttStatus(false);
    updateEsp32Status();
    connectMqtt();
    initCharts();
    loadHistory(1); // por defecto 24 h
  });
</script>
</body>
</html>
